(ns fantasia.sim.ecs.comprehensive-test
  (:require [brute.entity :as be]
            [fantasia.sim.ecs.core]
            [fantasia.sim.ecs.components]))

(println "=== ECS Comprehensive Test Suite ===")

(defn test-01-create-world
  "Test 1: Create ECS world"
  []
  (let [world (fantasia.sim.ecs.core/create-ecs-world)]
    (println "✓ Test 1 PASSED: Created ECS world")))

(defn test-02-create-agent
  "Test 2: Create agent entity"
  []
  (let [world (fantasia.sim.ecs.core/create-ecs-world)
        [eid world'] (fantasia.sim.ecs.core/create-agent world 1 0 0 :priest))]
    (println "✓ Test 2 PASSED: Created agent" eid)
    (when-not (= 1 (count (fantasia.sim.ecs.core/get-all-agents world')))
      (println "✗ Test 2 FAILED: Agent count mismatch"))))

(defn test-03-create-tile
  "Test 3: Create tile entity"
  []
  (let [world (fantasia.sim.ecs.core/create-ecs-world)
        [tile-key eid world'] (fantasia.sim.ecs.core/create-tile world 0 0 :ground :forest nil :wall))]
    (println "✓ Test 3 PASSED: Created tile" tile-key "with entity" eid)
    (when-not (= 1 (count (fantasia.sim.ecs.core/get-all-tiles world')))
      (println "✗ Test 3 FAILED: Tile count mismatch"))))

(defn test-04-create-stockpile
  "Test 4: Create stockpile"
  []
  (let [world (fantasia.sim.ecs.core/create-ecs-world)
        [eid world'] (fantasia.sim.ecs.core/create-stockpile world "0,0")]
    (println "✓ Test 4 PASSED: Created stockpile" eid)))

(defn test-05-create-multiple-agents
  "Test 5: Create multiple agents"
  []
  (let [world (fantasia.sim.ecs.core/create-ecs-world)
        [_ world'] (fantasia.sim.ecs.core/create-agent world 1 0 0 :priest))
        [_ world'] (fantasia.sim.ecs.core/create-agent world' 2 0 0 :knight))
        [_ world'] (fantasia.sim.ecs.core/create-agent world' 3 0 0 :peasant))
        agents (fantasia.sim.ecs.core/get-all-agents world'))]
    (println "✓ Test 5 PASSED: Created 3 agents")
    (when-not (= 3 (count agents))
      (println "✗ Test 5 FAILED: Expected 3 agents, got" (count agents)))))

(defn test-06-query-agent-components
  "Test 6: Query agent components"
  []
  (let [world (fantasia.sim.ecs.core/create-ecs-world)
        [eid world'] (fantasia.sim.ecs.core/create-agent world 1 0 0 :priest))
        pos-dummy (fantasia.sim.ecs.components/->Position 0 0))
        pos-type (be/get-component-type pos-dummy)
        position (be/get-component world' eid pos-type)]
    (when-not (and position (= (:q position) 0) (= (:r position) 0))
      (println "✗ Test 6 FAILED: Position component incorrect"))
      (println "✓ Test 6 PASSED: Position component correct"))))

(defn test-07-remove-component
  "Test 7: Remove component from entity"
  []
  (let [world (fantasia.sim.ecs.core/create-ecs-world)
        [eid world'] (fantasia.sim.ecs.core/create-agent world 1 0 0 :priest))
        world'' (fantasia.sim.ecs.core/remove-component world' eid (fantasia.sim.ecs.components/->Position 0 0))
        position-type (be/get-component-type (fantasia.sim.ecs.components/->Position 0 0))
        position (be/get-component world'' eid position-type)]
    (when position
      (println "✗ Test 7 FAILED: Position still exists after removal"))
      (println "✓ Test 7 PASSED: Component removed successfully"))))

(defn test-08-component-types
  "Test 8: Component type resolution"
  []
  (let [pos-dummy (fantasia.sim.ecs.components/->Position 0 0))
        pos-type (be/get-component-type pos-dummy)]
    (when-not (= pos-type (class pos-dummy))
      (println "✗ Test 8 FAILED: Component type mismatch"))
      (println "✓ Test 8 PASSED: Component type resolved correctly"))))

(defn run-all-tests
  "Run all tests"
  []
  (do
    (println "\n--- Running Tests ---\n")
    (test-01-create-world)
    (test-02-create-agent)
    (test-03-create-tile)
    (test-04-create-stockpile)
    (test-05-create-multiple-agents)
    (test-06-query-agent-components)
    (test-07-remove-component)
    (test-08-component-types)
    (println "\n--- Test Complete ---\n")))

(defn -main
  "Main entry point"
  [& args]
  (run-all-tests))