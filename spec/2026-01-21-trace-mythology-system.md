# Trace and Mythology System

## Core Concepts

### Facets (Universal Constants)
- **What:** Unchanging semantic primitives of the world
- **Examples:** `:fire`, `:rain`, `:cold`, `:judgment`, `:warmth`, `:danger`, `:community`
- **Role:** Adjectives that describe presence/absence of concepts
- **Properties:**
  - Universal across all cultures
  - Used by embedding system for semantic similarity
  - Never change or evolve
  - Stored in `fantasia.sim.spatial_facets/entity-facets`

### Events (Reality)
- **What:** Things that actually happen in the simulation
- **Examples:** Lightning strikes building, agent dies, temple burned, child born
- **Role:** Facts of reality, independent of interpretation
- **Properties:**
  - Objective occurrences
  - Have facets (what concepts they embody)
  - Timestamped, spatial (location)
  - Stored in `:recent-events` buffer

### Traces (Cultural Tokens)
- **What:** Cultural interpretations of events through mythology
- **Examples:** "The Night of Burning Judgment", "When Winter Spoke", "The Day Fire Remembered"
- **Role:** Names/stories that connect events to cultural beliefs
- **Properties:**
  - Culture-specific (different cultures interpret same event differently)
  - Generated by scribes
  - Readable texts (both in-simulation artifacts and player-readable)
  - Persistent myths that shape beliefs
  - Can be re-activated when similar events occur
  - Stored in `:traces` buffer, indexed by culture

### Scribes (Trace Generators)
- **What:** Agents whose job is to observe events and create traces
- **Role:** Transform raw events into cultural narratives
- **Behavior:**
  - Observe events within their cultural context
  - Use embeddings to find semantic connections between event facets and cultural vocabulary
  - Generate trace texts that resonate with existing mythology
  - Write traces to both simulation (agents can read) and player (debugger UI)

---

## Architecture

### Data Flow

```
Event Occurs
  ↓
Event has facets (e.g., [:fire :judgment :loss])
  ↓
Scribe observes event
  ↓
Scribe queries embedding space for cultural resonance
  ↓ (embedding similarity)
Scribe generates trace:
  - Name/title (culturally significant)
  - Full text (readable narrative)
  - Associated facets
  - Cultural attribution
  ↓
Trace stored in culture's mythology
  ↓
Trace influences future beliefs (agent recall biases)
```

### Embedding Usage

1. **Event Facets** → Query embedding space for:
   - Existing similar traces (find resonance with established mythology)
   - Cultural vocabulary (words that align with event facets)
   - Concept clusters (what themes this event touches)

2. **Trace Generation** → Use embeddings to:
   - Find semantically similar existing traces (build coherence)
   - Select culturally appropriate wording
   - Determine which cultural themes to emphasize

3. **Belief Influence** → Traces affect:
   - Event recall thresholds (culturally significant events easier to recall)
   - Claim selection (traced events bias claim activation)
   - Frontier seeding (trace facets add persistent activation)

---

## Schema

### Trace Structure

```clojure
{:trace/id "t-123"
 :culture-id "culture-1"           ; Which culture generated this trace
 :event-id "evt-456"               ; The original event
 :title "The Night of Burning Judgment"
 :text "When lightning struck the temple at the height of the storm,
        the elders saw not destruction, but revelation. The fire that
        consumed the roof was the same fire that brought the first
        laws to our people. This was no accident, but judgment made
        visible."
 :facets [:fire :judgment :storm :revelation :authority]
 :strength 0.75                    ; Cultural salience
 :created-at 1567
 :created-by :agent-id-12           ; The scribe who wrote it
 :referenced-traces ["t-098" "t-045"]  ; Links to related mythology
 :decay-rate 0.001                 ; Slow decay - myths persist
 :read-count 5                     ; How many times it's been read
 :canonical? false                  ; Has this become "core" mythology?
}
```

### Culture Structure

```clojure
{:culture/id "culture-1"
 :name "The Northern Covenant"
 :shared-facets [:fire :winter :judgment :community]
 :trace-vocabulary ["revelation" "covenant" "judgment" "test"]
 :trace-history ["t-001" "t-045" "t-098" "t-123"]
 :canonical-traces ["t-098"]
 :scribe-count 3
 :myth-density 0.72               ; How much mythology shapes belief
}
```

### Scribe Job State

```clojure
{:job/type :scribe
 :culture-id "culture-1"
 :observations []                    ; Events witnessed
 :wip-trace nil                     ; Currently being written
 :vocabulary-usage {:revelation 5 :judgment 12}
 :style {:formal true :prose-heavy false}
}
```

---

## Scribe Behavior

### 1. Event Observation

When an event occurs within the scribe's cultural scope:

```clojure
(defn scribe-observe-event!
  [world scribe event]
  (let [distance (hex/distance (:pos scribe) (:location event))
        in-scope? (<= distance (:vision scribe))
        relevant? (seq (filter #(contains? (:facets %) (:facets event))
                             (:shared-facets (:culture scribe))))]
    (when (and in-scope? relevant?)
      (update-in scribe [:job :observations] conj event))))
```

### 2. Trace Generation Decision

When should a scribe generate a trace?

- **Event significance:** Event has high-impact facets (`:death`, :judgment, :miracle`)
- **Cultural resonance:** Event facets align with culture's shared facets
- **Novelty:** No similar trace exists (checked via embeddings)
- **Capacity:** Scribe isn't currently writing another trace

```clojure
(defn should-generate-trace?
  [world scribe event]
  (let [event-facets (:facets event)
        culture (:culture scribe)
        resonance (embedding/resonance-score event-facets culture)
        similar-exists? (trace/find-similar-by-embedding world event-facets culture)]
    (and (or (seq (intersection event-facets high-impact-facets))
             (> resonance 0.6))
         (not similar-exists?)
         (not (:wip-trace (:job scribe))))))
```

### 3. Trace Text Generation

Using embeddings to craft culturally resonant text:

```clojure
(defn generate-trace-text!
  [world scribe event]
  (let [culture (:culture scribe)
        event-facets (:facets event)
        ;; Find similar traces for coherence
        similar-traces (trace/find-similar-by-embedding world event-facets culture 3)
        ;; Get vocabulary that aligns with event facets
        vocab-words (embedding/query-vocabulary event-facets culture)
        ;; Determine narrative structure
        narrative-structure (select-structure similar-traces event-facets)]
    (construct-text narrative-structure vocab-words similar-traces event)))
```

### 4. Trace Writing

Commit trace to culture and broadcast:

```clojure
(defn write-trace!
  [world scribe trace]
  (-> world
      (update-in [:cultures (:culture-id scribe) :trace-history] conj (:trace/id trace))
      (update-in [:cultures (:culture-id scribe) :canonical-traces]
                (fn [canon] (if (:canonical? trace) (conj canon (:trace/id trace)) canon)))
      (assoc-in [:traces (:trace/id trace)] trace)
      (broadcast! {:op "trace-created"
                   :trace trace
                   :scribe (:id scribe)})))
```

---

## Trace Evolution

### Persistence

Traces persist much longer than memories:

- **Standard decay:** 0.001 per tick (very slow)
- **Canonical traces:** No decay (core mythology)
- **Re-activation:** When similar event occurs, trace strength resets to 0.8

### Canonicalization

Traces become canonical when:
- Read by N+ agents (threshold: 20 reads)
- Referenced by M+ new traces (threshold: 5 references)
- Age > X ticks without losing resonance (threshold: 1000 ticks)

Canonical traces:
- Never decay
- Bias culture's facet weights
- Become available for all scribes as reference material
- Influence new trace generation style

### Belief Influence

Traces shape beliefs through:

1. **Event Recall Bias**
   ```clojure
   (defn event-recall-with-traces
     [frontier signature traces culture]
     (let [biased-signature
           (reduce-kv
             (fn [acc facet w]
               (let [trace-boost (trace/sum-facet-strength traces facet culture)]
                 (assoc acc facet (* w (+ 1.0 (* 0.5 trace-boost)))))
             signature
             signature)]
       (event-recall frontier biased-signature)))
   ```

2. **Claim Selection Bias**
   - Claims associated with culturally traced events get +0.15 bonus

3. **Frontier Seeding**
   - When agent reads a trace, its facets add persistent activation to frontier
   - Effect: `bump-facet frontier facet (* 0.1 trace-strength)`

---

## Implementation Plan

### Phase 1: Core Trace Schema
- [ ] Add `:cultures` to world state
- [ ] Define trace structure
- [ ] Add `:traces-by-culture` index

### Phase 2: Scribe Job
- [ ] Create `:scribe` job type
- [ ] Implement event observation
- [ ] Add trace generation decision logic

### Phase 3: Embedding-Based Text Generation
- [ ] Integrate embedding similarity for trace lookup
- [ ] Implement vocabulary querying from event facets
- [ ] Build text construction templates

### Phase 4: Trace Evolution
- [ ] Implement trace persistence/decay
- [ ] Add canonicalization logic
- [ ] Wire trace influence into event recall and claim selection

### Phase 5: UI Integration
- [ ] Display traces in culture panel
- [ ] Show trace generation events
- [ ] Link traces to original events
- [ ] Allow user to read full trace texts

---

## Definition of Done

- Scribes observe events within their cultural scope
- Traces generated have culturally resonant titles and texts
- Traces persist and evolve into canonical mythology
- Traces influence agent beliefs (recall, claim selection, frontier)
- User can read trace texts in debugger UI
- Embeddings used for semantic coherence in trace generation

---

## Open Questions

1. **Multiple cultures:** How should traces compete when cultures overlap?
2. **Trace style variation:** Should different scribes have distinct writing styles?
3. **Player agency:** Can the player influence trace generation (e.g., appoint scribes, provide templates)?
4. **Trace degradation:** Should traces become "forgotten" or just weak?
5. **Cross-cultural traces:** Can traces be translated/adopted by other cultures?

---

## Files to Modify

- `backend/src/fantasia/sim/world.clj` - Add cultures, traces structure
- `backend/src/fantasia/sim/jobs.clj` - Add scribe job type
- `backend/src/fantasia/sim/traces.clj` - Create trace generation, evolution logic
- `backend/src/fantasia/sim/embeddings.clj` - Trace lookup via similarity
- `backend/src/fantasia/sim/events.clj` - Hook into event observation
- `web/src/components/TraceFeed.tsx` - Display trace texts
- `web/src/components/CulturePanel.tsx` - Show cultural mythology
