# Unified Cultural Panel & Nomic Embeddings Spec

## Purpose
Merge Library, Thoughts, Traces, and Pantheon panels into one cohesive cultural panel. Implement runtime facet discovery using nomic text embeddings from ollama.

## Requirements

### 1. Unified Cultural Panel

**User Story**: As a player, I want a single panel that shows all cultural and mythological information - books, agent thoughts, traces, and deity relationships - so I can understand the colony's cultural development in one place.

**Functional Requirements**:

1. **Panel Structure**
   - Single collapsible panel called "Culture & Myth"
   - Tabbed interface for organizing content:
     - **Books**: Scribe-generated texts (each generating favor per tick)
     - **Thoughts**: Agent thoughts and mental states
     - **Traces**: Cultural traces and packet propagation
     - **Pantheon**: Deity favor/faith standings
   - Collapsible sections within each tab (optional)
   - Dark theme consistent with existing UI

2. **Books Tab**
   - List of books generated by scribes
   - Each book shows:
     - Title
     - Preview text
     - Generation tick
     - Sources (trace count)
     - Read count
     - **Favor per tick** (new field, default 0.001)
   - Click to expand full text
   - Show total favor being generated per tick

3. **Thoughts Tab**
   - Selected agent thought (highlighted)
   - Recent agent thoughts (top 8)
   - Needs status indicators (food, warmth, sleep)
   - Urgency levels (OK, WARNING, CRITICAL)
   - Top facets per agent

4. **Traces Tab**
   - Recent cultural traces
   - Packet spread visualization
   - Event recall information
   - Mention tracking
   - Facet discovery status

5. **Pantheon Tab**
   - Global favor/faith totals
   - Individual deity cards with:
     - Deity name
     - Favor progress bar
     - Faith progress bar
     - Color-coded strength
   - Deity count

### 2. Nomic Text Embeddings from Ollama

**Current System**:
- Uses GloVe-style pre-trained embeddings
- Fallback deterministic embeddings when missing
- Static entity facets defined at startup

**New System**:
- Use nomic-embed-text via ollama
- Runtime facet discovery
- Dynamic embedding cache
- Embeddings loaded on-demand for new terms

**Technical Implementation**:

#### Backend (Clojure)

**File**: `backend/src/fantasia/sim/embeddings.clj` (new namespace)

```clojure
(ns fantasia.sim.embeddings
  (:require [clj-http.client :as http]
            [cheshire.core :as json]
            [fantasia.dev.logging :as log]))

;; Nomic embedding cache (text -> vector map)
(defonce ^:private nomic-cache (atom {}))

(defonce ^:private max-cache-size 1000)

;; Ollama configuration
(defn get-ollama-config
  "Get Ollama configuration from world levers."
  [world]
  {:url (get-in world [:levers :ollama-url] "http://localhost:11434/api/embed")
   :model (get-in world [:levers :ollama-embed-model] "nomic-embed-text")
   :timeout-ms (get-in world [:levers :ollama-embed-timeout-ms] 10000)})

(defn call-nomic-embed!
  "Call Ollama nomic-embed-text API to get embedding vector.
   Returns {:success true :vector [...] :model \"nomic-embed-text\"}
   or {:success false :error \"...\"}"
  [text config]
  (try
    (let [url (:url config)
          model (:model model)
          response (http/post url
                              {:content-type :json
                               :body (json/generate-string
                                       {:model model
                                        :input text
                                        :truncate true})
                               :throw-exceptions false
                               :socket-timeout (:timeout-ms config)
                               :connection-timeout 5000})]
      (if (= (:status response) 200)
        (let [body (json/parse-string (:body response) true)
              embedding (get-in body [:embeddings 0 :embedding])]
          (if (and embedding (vector? embedding))
            {:success true :vector embedding :model model}
            {:success false :error "No embedding in response"}))
        {:success false :error (str "HTTP " (:status response))}))
    (catch Exception e
      (log/log-error "[NOMIC:EMBED]" {:error (.getMessage e) :text (subs text 0 50)})
      {:success false :error (.getMessage e)})))

(defn get-or-create-embedding!
  "Get embedding from cache or create using nomic API.
   Returns embedding vector or nil on failure."
  [text config]
  (let [cache-key (str text)]
    (if-let [cached (get @nomic-cache cache-key)]
      cached
      (let [{:keys [success vector]} (call-nomic-embed! text config)]
        (when (and success vector)
          ;; Cache with LRU eviction
          (when (>= (count @nomic-cache) max-cache-size)
            (swap! nomic-cache
                     #(-> %
                          (seq)
                          (drop 1)
                          (into {}))))
          (swap! nomic-cache assoc cache-key vector))
        vector)))))

(defn cosine-similarity
  "Compute cosine similarity between two vectors."
  [v1 v2]
  (when (and v1 v2)
    (let [dot (reduce + 0 (map * v1 v2))
          mag1 (Math/sqrt (reduce + 0 (map #(* % %) v1)))
          mag2 (Math/sqrt (reduce + 0 (map #(* % %) v2)))]
      (if (and (pos? mag1) (pos? mag2))
        (/ dot (* mag1 mag2))
        0.0))))

(defn init-embeddings!
  "Initialize embedding system (cache is empty at start)."
  []
  (log/log-info "[NOMIC] Embedding system initialized")
  {:loaded? true})
```

#### Integration with spatial_facets.clj

**Update** `backend/src/fantasia/sim/spatial_facets.clj`:

```clojure
(ns fantasia.sim.spatial_facets
  (:require [...]
            [fantasia.sim.embeddings :as embeddings]))

;; Replace embedding-cache atom with reference to nomic system

(defn query-concept-axis!
  "Query concept using nomic embeddings."
  [world agent concept {:keys [max-facets max-distance]}]
  (let [config (embeddings/get-ollama-config world)
        max-facets (or max-facets (:facet-limit world) 16)
        max-distance (or max-distance (:vision agent) 10)
        ;; ... gather facets as before ...
        concept-embedding (embeddings/get-or-create-embedding! (name concept) config)]
    (if concept-embedding
      ;; Compute cosine similarity for each facet word
      (let [score (reduce
                      (fn [acc word]
                        (let [word-embedding (embeddings/get-or-create-embedding! (str word) config)]
                          (if word-embedding
                            (+ acc (embeddings/cosine-similarity word-embedding concept-embedding))
                            acc)))
                      0.0
                      facet-words)]
        (max -1.0 (min 1.0 score)))
      0.0)))
```

#### Runtime Facet Discovery

**New namespace**: `backend/src/fantasia/sim/facet_discovery.clj`

```clojure
(ns fantasia.sim.facet-discovery
  (:require [fantasia.sim.embeddings :as embeddings]))

(defonce discovered-facets (atom #{}))

(defn discover-facets-from-text!
  "Extract potential facet words from text using nomic embeddings.
   Returns list of new facet candidates."
  [text world]
  (let [config (embeddings/get-ollama-config world)
        words (str/split text #"\s+")
        candidates (->> words
                     (map str/lower-case)
                     (filter #(> (count %) 2))
                     (distinct))]
    (reduce
      (fn [acc word]
        (if (contains? @discovered-facets word)
          acc
          (let [embedding (embeddings/get-or-create-embedding! word config)]
            (if embedding
              (do
                (swap! discovered-facets conj word)
                (conj acc word))
              acc))))
      []
      candidates)))

(defn get-all-discovered-facets
  "Get all facets discovered at runtime."
  []
  (vec @discovered-facets))
```

### 3. Books Generate Favor Per Tick

**Update**: `backend/src/fantasia/sim/tick.clj`

Add per-tick favor generation from books:

```clojure
(defn apply-book-favor!
  "Generate favor from books each tick.
   Each book generates favor_per_tick * (1 + read_count * 0.1)."
  [world]
  (let [books (vals (:books world))
         favor-gain (reduce
                      (fn [acc book]
                        (let [favor-per-tick (get book :favor-per-tick 0.001)
                              read-count (get book :read-count 0)
                              multiplier (+ 1.0 (* read-count 0.1))]
                          (+ acc (* favor-per-tick multiplier))))
                      0.0
                      books)]
    (update-in world [:favor] + favor-gain)))
```

**Update** `backend/src/fantasia/sim/scribes.clj`:

```clojure
(defn create-book-placeholder
  [book-id trace-ids title facets created-at created-by]
  {:book/id book-id
   :trace-ids trace-ids
   :title title
   :text "The scribes are still writing this book..."
   :facets facets
   :created-at created-at
   :created-by created-by
   :read-count 0
   :favor-per-tick 0.001
   :generating? true})
```

### 4. Frontend Implementation

**File**: `web/src/components/CulturalPanel.tsx` (new component)

```typescript
import React, { useState } from "react";

type Tab = "books" | "thoughts" | "traces" | "pantheon";

type CulturalPanelProps = {
  books: Record<string, any>;
  agents: Agent[];
  selectedAgent: Agent | null;
  traces: Trace[];
  deities: Record<string, { favor: number; faith: number }>;
  globalFavor: number;
  globalFaith: number;
  collapsed?: boolean;
  onToggleCollapse?: () => void;
};

export function CulturalPanel({
  books,
  agents,
  selectedAgent,
  traces,
  deities,
  globalFavor,
  globalFaith,
  collapsed = false,
  onToggleCollapse
}: CulturalPanelProps) {
  const [activeTab, setActiveTab] = useState<Tab>("books");

  const tabs = [
    { id: "books" as Tab, label: "Books", count: Object.keys(books).length },
    { id: "thoughts" as Tab, label: "Thoughts", count: agents.length },
    { id: "traces" as Tab, label: "Traces", count: traces.length },
    { id: "pantheon" as Tab, label: "Pantheon", count: Object.keys(deities).length },
  ];

  return (
    <div style={{ /* dark theme styles */ }}>
      <div /* collapsible header */>
        <strong>Culture & Myth</strong>
      </div>

      {!collapsed && (
        <div>
          {/* Tab Navigation */}
          <div style={{ display: "flex", gap: 4 }}>
            {tabs.map(tab => (
              <button key={tab.id} onClick={() => setActiveTab(tab.id)}>
                {tab.label} ({tab.count})
              </button>
            ))}
          </div>

          {/* Tab Content */}
          {activeTab === "books" && <BooksTab books={books} />}
          {activeTab === "thoughts" && <ThoughtsTab agents={agents} selectedAgent={selectedAgent} />}
          {activeTab === "traces" && <TracesTab traces={traces} />}
          {activeTab === "pantheon" && <PantheonTab deities={deities} globalFavor={globalFavor} globalFaith={globalFaith} />}
        </div>
      )}
    </div>
  );
}
```

### 5. Ollama Configuration

Add new levers in `backend/src/fantasia/sim/tick/initial.clj`:

```clojure
:levers {:ollama-url "http://localhost:11434/api/embed"
          :ollama-embed-model "nomic-embed-text"
          :ollama-embed-timeout-ms 10000
          :ollama-url "http://localhost:11434/api/generate"
          :ollama-model "qwen3:4b"
          :ollama-timeout-ms 60000
          :ollama-retries 1
          :ollama-retry-delay-ms 2000
          :ollama-keep-alive-enabled true
          :ollama-keep-alive-interval-ms 300000
          :iconography {:fire->patron 0.80
                      :lightning->storm 0.75
                      :storm->deity 0.85}
          :mouthpiece-agent-id nil
          :default-culture-id "culture-1"}
```

### 6. Implementation Plan

#### Phase 1: Backend Embeddings System
- [ ] Create `embeddings.clj` namespace with nomic integration
- [ ] Add Ollama embedding configuration to levers
- [ ] Test nomic embedding API calls
- [ ] Update `spatial_facets.clj` to use new embeddings

#### Phase 2: Facet Discovery
- [ ] Create `facet_discovery.clj` namespace
- [ ] Implement text-based facet extraction
- [ ] Integrate discovery with books/traces
- [ ] Update snapshot to include discovered facets

#### Phase 3: Book Favor System
- [ ] Add `:favor-per-tick` field to books
- [ ] Implement per-tick favor generation
- [ ] Update book creation to include favor-per-tick
- [ ] Test favor accumulation

#### Phase 4: Frontend Cultural Panel
- [ ] Create `CulturalPanel.tsx` component
- [ ] Implement tabbed interface
- [ ] Migrate Books tab from LibraryPanel
- [ ] Migrate Thoughts tab from ThoughtsPanel
- [ ] Migrate Traces tab from TraceFeed
- [ ] Migrate Pantheon tab from MythPanel
- [ ] Add total favor per tick indicator

#### Phase 5: Integration
- [ ] Replace old panels with CulturalPanel in App.tsx
- [ ] Connect WebSocket data
- [ ] Add levers for embedding configuration
- [ ] Test all tabs

### Definition of Done
- [ ] Single CulturalPanel component replaces Library, Thoughts, TraceFeed, and MythPanel
- [ ] Tabbed interface works smoothly
- [ ] Books generate favor per tick (visible in UI)
- [ ] Nomic embeddings functional via ollama
- [ ] Runtime facet discovery working
- [ ] All data updates correctly on WebSocket
- [ ] No console errors
- [ ] Follows AGENTS.md style guidelines

### References
- `backend/src/fantasia/sim/spatial_facets.clj` - Current embedding system
- `backend/src/fantasia/sim/scribes.clj` - Book generation
- `web/src/components/LibraryPanel.tsx` - Current library panel
- `web/src/components/ThoughtsPanel.tsx` - Current thoughts panel
- `web/src/components/TraceFeed.tsx` - Current traces panel
- `web/src/components/MythPanel.tsx` - Current pantheon panel
- `spec/2026-01-15-myth-engine.md` - Myth engine documentation
- Ollama embedding API: https://github.com/ollama/ollama/blob/main/docs/api.md#generate-embeddings

### Future Enhancements
- Semantic search across all cultural content
- Facet-based book recommendations
- Cultural trend visualization over time
- Deity relationship graph
- Multi-cultural support
- Artifact-based favor bonuses (statues, shrines)
