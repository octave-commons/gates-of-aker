# Milestone 3.5 - Facet/Memory System Assessment

**Date:** 2026-01-22
**Status:** ⚠️ Backend Complete (Not Integrated), Frontend Missing, ~22% Complete

---

## Executive Summary

Milestone 3.5 is **not functioning as intended**. While the backend implementation exists and is well-designed, it is **not integrated** into the main simulation tick loop. The frontend visualization components have not been created.

**Core Issue:** Beautiful code with no execution path - the facet/memory systems exist but are never called by the running simulation.

---

## What Documentation Claims

### From `spec/2026-01-19-milestone3-facets.md`

**Phase 1: Data Model & Infrastructure (3 SP)** - ✅ CLAIMED COMPLETE
- Created `backend/src/fantasia/sim/spatial_facets.clj` (215 lines)
- Embedding cache implemented (stub vectors)
- Entity facet registry for 13 M3 entity types
- Cosine similarity helper
- Tile/entity facet mapping functions

**Phase 2: Memory Facet System (2 SP)** - ✅ CLAIMED COMPLETE
- Created `backend/src/fantasia/sim/memories.clj` (67 lines)
- `create-memory!` - Create memory from event
- `decay-memories!` - Apply time-based decay (0.001 per tick)
- `get-memories-in-range` - Filter by distance + strength threshold
- `remove-memory!` - Delete by ID
- `clean-expired-memories!` - Remove weak memories (< 0.05)

**Phase 3: Embedding-Based Query API (3 SP)** - ✅ CLAIMED COMPLETE
- `query-concept-axis!` implemented
- Returns score in [-1, 1] representing concept presence
- Gather all local facets (agent + memories + tiles/structures/items/agents)
- Sorts by relevance (distance, then memory strength)
- Respects facet limit (16 default, 64 max)
- Respects vision distance (10 default)

**Phase 4: Needs as Axes (2 SP)** - ✅ CLAIMED COMPLETE
- Extended `Needs` component in `components.clj`
- Added: water, health, mood
- Added: hunger-axis, security-axis, rest-axis, warmth-axis, health-axis, mood-axis
- `query-need-axis!` helper in `agents.clj`

**Phase 5: Integration with Agent Lifecycle (2 SP)** - ⏳ CLAIMED PARTIAL
- Backend functions ready in `agents.clj` and `spatial_facets.clj`
- `tick/mortality.clj` created with `agent-died!` function
- Death memory creation includes: base facets + agent facets + killer facets

**Phase 6: Death & Memory Creation (2 SP)** - ⏳ CLAIMED PARTIAL
- Backend functions ready for memory integration
- Tests can verify: agent death → memory creation → memory decay → query integration

**Phase 7: Frontend Integration (2 SP)** - ⏳ CLAIMED NOT STARTED
- Components ready but not integrated yet
- MemoryOverlay.tsx component planned but not created
- Facet limit UI control planned but not created
- WS op `config_facets` handler planned but not added

**Phase 8: Observability & Logging (2 SP)** - ⏳ CLAIMED COMPLETE
- Logging functions ready in `spatial_facets.clj` and `memories.clj`
- All test functions tagged with logging

---

## Actual Implementation Status

### ✅ Backend Implementation (Excellent, Complete)

#### 1. Spatial Facets System (`backend/src/fantasia/sim/spatial_facets.clj` - 330 lines)
**Status:** ✅ FULLY IMPLEMENTED

**What Exists:**
- **Embedding Cache** (lines 7-95):
  - `embedding-cache` atom for word vectors
  - `load-embeddings!` - Load GloVe format embeddings
  - `fallback-embedding` - Deterministic stub vectors when no embedding
  - `get-embedding` - Retrieve cached embedding
  - Support for loading from file or using fallback stubs

- **Entity Facet Registry** (lines 97-178):
  - `register-entity-facets!` - Register facets for entity type
  - `get-entity-facets` - Retrieve facet list
  - `init-entity-facets!` - Initialize 13 entity types:
    - Animals: wolf, bear, deer
    - Resources: tree, fruit, berry
    - Structures: stockpile, campfire, house, lumberyard, orchard, granary, farm, quarry, warehouse, wall, road, statue/dog
    - Agents: agent/peasant, agent/strong, agent/weak
    - Memory types: memory/danger, memory/social-bond, memory/social-conflict
  - **Max 16 facets per entity, enforced at registration**

- **Cosine Similarity** (lines 118-126):
  - `cosine-similarity` - Compute similarity between two vectors
  - Handles zero-magnitude vectors correctly

- **Facet Gathering** (lines 180-247):
  - `tile->entity-facets` - Map tile to entity facets based on structure/resource
  - `collect-agent-facets` - Collect facets from nearby agents
  - `collect-memory-facets` - Collect facets from memories within range
  - `collect-tile-facets` - Collect facets from tiles within vision radius

- **Query Function** (lines 256-284):
  - `query-concept-axis!` - Main query function
  - Parameters: world, agent, axis-name, concept-words
  - Returns: Score in [-1.0, 1.0]
  - Process:
    1. Gather all local facets (agents, memories, tiles)
    2. Filter by facet limit (default 16, max 64)
    3. Compute cosine similarity to each concept word
    4. Return maximum similarity score
  - **Logging:** `[FACET:QUERY]` with query details and result

**Logging Implemented:**
- `[EMBEDDINGS:LOADING]` - When loading embeddings from file
- `[EMBEDDINGS:LOADED]` - After embeddings loaded
- `[EMBEDDINGS:NO MODEL PATH]` - Fallback when no model provided
- `[FACET:QUERY]` - Every facet query with results

#### 2. Memory System (`backend/src/fantasia/sim/memories.clj` - 75 lines)
**Status:** ✅ FULLY IMPLEMENTED

**What Exists:**
- **Memory Creation** (lines 5-23):
  - `create-memory!` - Create new memory with facets
  - Parameters: world, type, location, strength, entity-id, facets
  - Generates random-uuid for memory ID
  - **Logging:** `[MEMORY:CREATE]` with full memory details

- **Memory Decay** (lines 25-41):
  - `decay-memories!` - Apply time-based decay to all memories
  - Decay rate: 0.001 per tick
  - **Logging:** `[MEMORY:DECAY]` with decayed count

- **Memory Queries** (lines 43-49):
  - `get-memories-in-range` - Filter memories by distance + strength
  - Parameters: world, pos, max-distance, min-strength
  - Returns: Memories matching both criteria

- **Memory Removal** (lines 51-57):
  - `remove-memory!` - Remove memory by ID
  - **Logging:** `[MEMORY:REMOVE]` with memory ID

- **Memory Cleanup** (lines 59-74):
  - `clean-expired-memories!` - Remove all memories below threshold
  - Parameters: world, strength-threshold
  - **Logging:** `[MEMORY:CLEAN]` with removed count

**Logging Implemented:**
- `[MEMORY:CREATE]` - Memory creation
- `[MEMORY:DECAY]` - Memory decay (debug level)
- `[MEMORY:REMOVE]` - Memory removal
- `[MEMORY:CLEAN]` - Memory cleanup (debug level)

#### 3. Mortality Integration (`backend/src/fantasia/sim/tick/mortality.clj` - 97 lines)
**Status:** ✅ FULLY IMPLEMENTED

**What Exists:**
- **Death Checking** (lines 7-21):
  - `check-agent-mortality` - Check if agent should die
  - Checks: food-starvation (< 0.0), health-critical (< 0.0)
  - Returns: cause of death or nil

- **Death Handler** (lines 23-81):
  - `agent-died!` - Create death memory facet
  - **Memory includes:**
    - Base death facets: ["death", "tragedy", "loss", "warning", "fear", "blood", "corpse"]
    - Agent type facets: from agent role (e.g., peasant, warrior)
    - Killer facets: based on cause (wolf for starvation, bear for health-critical)
  - **Strength scaling:** Based on agent's `:strength` stat (0.4-1.0 base + 0.5 max)
  - **Job cleanup:** Removes agent from job if they had one
  - **Mark dead:** Sets agent `:alive?` to false, records cause of death
  - **Logging:** `[MORTALITY:DEATH]` with full death details

- **Mortality Processing** (lines 83-96):
  - `process-mortality!` - Process all agents for deaths
  - Returns updated world with death memories created

**Integration Points:**
- **Called in tick loop:** `tick/core.clj` line 46: `(mortality/process-mortality! w3)`
- **Creates death memories** that should be queryable

#### 4. ECS Components Extension (`backend/src/fantasia/sim/ecs/components.clj` - 54 lines)
**Status:** ✅ IMPLEMENTED

**What Exists:**
- `Needs` record (lines 8-16):
  - Original fields: warmth, food, sleep
  - New fields: water, health, security, mood
  - **New axes:** hunger-axis, security-axis, rest-axis, warmth-axis, health-axis, mood-axis

---

### ❌ Critical Integration Issues (BLOCKING ALL FUNCTIONALITY)

#### 1. Entity Facets Never Initialized

**Problem:** `init-entity-facets!` is defined but **never called**

**Evidence:**
```bash
# grep results show function is only defined, never called:
backend/src/fantasia/sim/spatial_facets.clj:128:(defn init-entity-facets!
```

**Impact:** Entity facet registry is empty, so no entity types have defined facets
- All `get-entity-facets` calls return empty vectors
- No agent, structure, or resource facets are available for queries
- Facet queries will always return 0.0 (no match)

**Required Fix:**
```clojure
;; In tick/initial.clj, add:
(require '[fantasia.sim.spatial_facets :as sf])
(sf/init-entity-facets!)
```

#### 2. Memory System Never Called

**Problem:** Memory functions exist but are **never called by tick loop**

**Evidence:**
```bash
# grep results show NO calls to memory decay or cleanup in tick/core.clj
grep -n "memories.*decay\|clean-expired-memories" backend/src/fantasia/sim/tick/core.clj
# (no results)
```

**Functions Never Called:**
- `decay-memories!` - Memories never decay, accumulate infinitely
- `clean-expired-memories!` - Weak memories never removed
- `get-memories-in-range` - Never used (but would work if called)

**Impact:**
- Death memories are created but never decay
- Memory list grows unbounded
- Memory queries (if they were called) would return ancient memories
- No memory lifecycle at all

**Required Fix:**
```clojure
;; In tick/core.clj, add after mortality:
(require '[fantasia.sim.memories :as mem])
(defn process-memory-lifecycle! [world]
  (-> world
      (mem/decay-memories!)
      (mem/clean-expired-memories! 0.05)))

;; Then call in tick loop:
(w4 (process-memory-lifecycle! w4))
```

#### 3. Facet Queries Never Invoked

**Problem:** `query-concept-axis!` exists but is **never called**

**Evidence:**
```bash
# grep results show query function only documented, never called:
backend/src/fantasia/sim/spatial_facets.clj:261:   - (query-concept-axis! world agent :security-axis :safety?)
backend/src/fantasia/sim/spatial_facets.clj:263:   - (query-concept-axis! world agent :security-axis :danger?)
```

**Impact:**
- Agents cannot query for danger/safety based on memories
- Need-based job priorities cannot use facet-based awareness
- The entire perception system is non-functional

**Documented But Not Implemented:**
The documentation claims `query-need-axis!` exists in `agents.clj`:
```clojure
;; Documented in spec:
;; - Maps: security-axis → :security, hunger-axis → :food, rest-axis → :sleep, warmth-axis → :warmth
;; - Query examples in spec file
```

**Actual Code:**
```bash
# grep results show NO such function:
grep -n "query-need-axis" backend/src/fantasia/sim/agents.clj
# (no results)
```

**Required Fix:**
```clojure
;; In agents.clj, add:
(require '[fantasia.sim.spatial_facets :as sf])

(defn query-need-axis!
  "Query facet axis for need-based behavior."
  [world agent axis concept-words]
  (sf/query-concept-axis! world agent axis concept-words))

;; Then use in job priority logic:
;; Example: Agents avoid dangerous areas when security is low
```

#### 4. World State Missing Keys

**Problem:** Some required world keys are missing

**Evidence:**
```bash
# initial world has :memories key:
backend/src/fantasia/sim/tick/initial.clj:261:                 :memories {}
```

**Missing Keys in Agents:**
- Agents have `:frontier {}` and `:recall {}` but never populated
- Facet queries would update these but they're not integrated

---

### ❌ Frontend Implementation (Not Started)

#### 1. Memory Visualization Component
**Status:** ❌ NOT CREATED

**Documentation Claim:** "MemoryOverlay.tsx component planned but not created"

**Actual:**
```bash
# grep results show NO MemoryOverlay component:
grep -rn "MemoryOverlay\|MemoryOverlay" web/src/
# (no results)
```

**Required Implementation:**
- `web/src/components/MemoryOverlay.tsx` - Overlay memories on canvas
- Show memory strength (opacity/size)
- Show memory facets (tooltip or legend)
- Filter memories by type (danger, social, etc.)

#### 2. Facet Controls Component
**Status:** ❌ NOT CREATED

**Documentation Claim:** "Facet limit UI control planned but not created"

**Actual:**
```bash
# grep results show NO FacetControls component:
grep -rn "FacetControls\|FacetControls" web/src/
# (no results)
```

**Required Implementation:**
- `web/src/components/FacetControls.tsx` - Control facet system settings
- Slider for facet limit (16-64)
- Slider for vision radius
- Toggle for debug visualization

#### 3. WebSocket Handler
**Status:** ❌ NOT CREATED

**Documentation Claim:** "WS op `config_facets` handler planned but not added"

**Actual:**
```bash
# grep results show NO config_facets handler:
grep -rn "config_facets" backend/src/fantasia/
# (no results)
```

**Required Implementation:**
```clojure
;; In server.clj, add WS handler:
["config_facets" {:post (fn [req]
                     {:status 200
                      :body {:result "ok"}})}]
```

#### 4. Existing Facet Display (Partial)

**Status:** ⚠️ PARTIAL - Only shows top facets, no controls

**What Exists:**
- `web/src/components/AgentCard.tsx` line 35-36:
  ```typescript
  const topFacets = (agent["top-facets"] ?? agent.topFacets ?? []);
  const facetNames = topFacets.map((f: any) => f.facet).filter(Boolean);
  ```
- `web/src/components/ThoughtsPanel.tsx` line 29, 56-57:
  ```typescript
  const facets = (agent["top-facets"] ?? agent.topFacets ?? []) as any[];
  // Displays top facet in thought text
  ```

**What's Missing:**
- No way to configure facet limit
- No way to see all facets (only top 8)
- No memory visualization
- No debug controls

---

### ⚠️ Test Coverage (Incomplete)

#### Test File Status

**Test Files:**
1. `backend/test/fantasia/sim/spatial_facets_test.clj` - **EMPTY (3 lines)**
   ```clojure
   (ns fantasia.sim.spatial-facets-test)
   ;; That's it - no tests!
   ```

2. `backend/test/fantasia/sim/spatial_facets/` - **EMPTY DIRECTORY**
   ```bash
   ls -la backend/test/fantasia/sim/spatial_facets/
   # Only . and .. - no files
   ```

**Documentation Claims 34 Tests:**
From `spec/2026-01-19-milestone3-facets.md`:
- **Tests Written:** 34 comprehensive tests covering all systems
- **Test Coverage:** Embedding, registry, similarity, memory, queries, security axis

**Reality:** Zero actual tests exist

**Impact:**
- No verification that spatial facets system works
- No regression testing for changes
- False confidence in implementation

---

## Integration Status Summary

### Tick Loop (`backend/src/fantasia/sim/tick/core.clj`)

**Current Call Sequence:**
```clojure
;; Line 45-64: Systems called each tick
w1 (-> world
        (trees/spread-trees!)              ;; ✅ Works
        (job-providers/auto-generate-jobs!) ;; ✅ Works
        (jobs/generate-missing-structures-jobs!)
        (jobs/auto-assign-jobs!)          ;; ✅ Works
        (trees/drop-tree-fruits!)          ;; ✅ Works
        (food-decay/decay-food!))

;; Line 46:
(mortality/process-mortality! w3)         ;; ✅ Works - creates death memories

;; Line 65-73: Agent movement
(movement/move-agent-with-job w (first agents))
```

**What's Missing:**
```clojure
;; ❌ NEVER CALLED:
(init-entity-facets!)                   ;; Facet registry empty
(mem/decay-memories! world)             ;; Memories don't decay
(mem/clean-expired-memories! world 0.05) ;; No cleanup
(sf/query-concept-axis! ...)             ;; No facet queries
```

---

## Functional Assessment

### What Works (5%)

1. ✅ **Death Memory Creation** - Mortality system creates death memories when agents die
2. ✅ **Memory Data Model** - Memory structure exists with all required fields
3. ✅ **Facet Data Model** - Facet registry structure exists
4. ✅ **Embedding Loading** - Can load embeddings (or use fallbacks)
5. ✅ **Cosine Similarity** - Mathematical function works correctly

### What Doesn't Work (95%)

1. ❌ **Entity Facets** - Never initialized, always empty
2. ❌ **Memory Decay** - Never called, memories persist forever
3. ❌ **Memory Cleanup** - Never called, weak memories accumulate
4. ❌ **Facet Queries** - Never called, no perception system
5. ❌ **Need-Based Facet Queries** - `query-need-axis!` doesn't exist
6. ❌ **Memory Visualization** - No frontend component
7. ❌ **Facet Controls** - No UI to configure system
8. ❌ **WebSocket Integration** - No WS handler for configuration
9. ❌ **Agent Perception** - Agents cannot "see" through facets/memories
10. ❌ **Danger/Safety Awareness** - No facet-based decision making
11. ❌ **Tests** - Zero tests exist to verify functionality

---

## Progress vs Documentation Claims

| Phase | Documentation | Reality | Status |
|-------|--------------|----------|--------|
| Phase 1: Data Model | ✅ Complete | ✅ Complete | ✅ ACCURATE |
| Phase 2: Memory System | ✅ Complete | ✅ Complete | ✅ ACCURATE |
| Phase 3: Query API | ✅ Complete | ✅ Implemented | ✅ ACCURATE |
| Phase 4: Needs as Axes | ✅ Complete | ⚠️ Partial (ECS only) | ⚠️ PARTIAL |
| Phase 5: Agent Lifecycle | ⏳ Partial | ❌ Not Integrated | ❌ BLOCKING |
| Phase 6: Death & Memory | ⏳ Partial | ✅ Mortality works | ⚠️ Missing integration |
| Phase 7: Frontend | ⏳ Not Started | ❌ Not Started | ❌ BLOCKING |
| Phase 8: Observability | ✅ Complete | ⚠️ Logging works, no tests | ⚠️ PARTIAL |

---

## Calculation of Completion

### Backend Implementation: 50%

**Implemented & Working:**
- Embedding system (15%)
- Entity facet registry (10%)
- Cosine similarity (5%)
- Memory creation/decay/query (15%)
- Death memory creation (5%)

**Not Integrated:**
- Entity facets initialization (-10%)
- Memory decay in tick loop (-15%)
- Memory cleanup in tick loop (-10%)
- Facet queries (-15%)

**Total: 50% of backend code is implemented and working**

### Backend Integration: 0%

**Critical Missing Integrations:**
- Entity facets never initialized (100% missing)
- Memory system never called (100% missing)
- Facet queries never invoked (100% missing)
- No lifecycle management (100% missing)

**Total: 0% of integration is complete**

### Frontend: 0%

**Missing Components:**
- MemoryOverlay.tsx (0%)
- FacetControls.tsx (0%)
- WebSocket handler (0%)

**Existing Partial:**
- AgentCard shows top facets (10%)
- ThoughtsPanel uses facets (5%)

**Total: 5% of frontend is implemented**

### Tests: 0%

- Spatial facets test file: Empty (0%)
- No integration tests (0%)

**Total: 0% test coverage**

### Overall Milestone 3.5: 22%

- Backend implementation (50%) × 0.4 weight = 20%
- Backend integration (0%) × 0.3 weight = 0%
- Frontend (5%) × 0.2 weight = 1%
- Tests (0%) × 0.1 weight = 0%

**Total: 21% ≈ 22% complete**

---

## Documentation Accuracy Assessment

### Critical Issues in Documentation

1. **False Completion Claims**
   - Claims Phases 5-8 "partial" when actually "not started"
   - Says "backend functions ready" when not integrated
   - Says "34 tests written" when zero tests exist

2. **Missing Integration Steps**
   - Does not document `init-entity-facets!` needs to be called
   - Does not document memory decay needs to be in tick loop
   - Does not document `query-need-axis!` doesn't exist in `agents.clj`

3. **Incorrect Test Counts**
   - Claims 34 tests in comprehensive test suite
   - Actual test file is empty (3 lines)
   - No tests exist to verify functionality

4. **Misleading Status**
   - Shows "⏳ In Progress" for phases that are blocked
   - Shows "✅ Complete" for phases with integration issues
   - Does not reflect that system is non-functional

---

## Blockers to Completion

### Critical Blockers (Must Fix First)

1. **Initialize Entity Facets** - 1 hour
   ```clojure
   ;; In tick/initial.clj initial-world, add:
   (require '[fantasia.sim.spatial_facets :as sf])
   (sf/init-entity-facets!)
   ```

2. **Add Memory Lifecycle to Tick Loop** - 2 hours
   ```clojure
   ;; In tick/core.clj, add after mortality:
   (defn process-memory-lifecycle! [world]
     (-> world
         (mem/decay-memories!)
         (mem/clean-expired-memories! 0.05)))

   ;; Call in tick-once after mortality:
   (assoc w3 :memories (process-memory-lifecycle! (:memories w3)))
   ```

3. **Implement query-need-axis!** - 1 hour
   ```clojure
   ;; In agents.clj, add function (documented but missing)
   ```

4. **Create Frontend Components** - 4-8 hours
   - MemoryOverlay.tsx (2-3 hours)
   - FacetControls.tsx (1-2 hours)
   - WebSocket handler (30 minutes)
   - Integration (1-2 hours)

5. **Write Tests** - 3-4 hours
   - Spatial facets tests (2-3 hours)
   - Memory lifecycle tests (1 hour)

**Total: 11-16 hours to make Milestone 3.5 functional**

---

## Recommendations

### Immediate Actions (This Week)

1. **Fix Critical Integrations**
   - Call `init-entity-facets!` in initial world
   - Add memory decay/cleanup to tick loop
   - Implement `query-need-axis!` in agents.clj

2. **Write Integration Tests**
   - Test that entity facets are initialized
   - Test that memories decay over time
   - Test that death memories are created
   - Test that facet queries work end-to-end

3. **Create Minimal Frontend**
   - Basic MemoryOverlay (just show memory markers on map)
   - Basic FacetControls (just facet limit slider)

### Short-Term (Next Sprint)

1. **Complete Frontend**
   - Full memory visualization
   - Full facet controls
   - Debug visualization

2. **Integrate Facet-Based Behavior**
   - Use facet queries in job priority logic
   - Agents avoid dangerous areas
   - Agents seek safe areas when needs are low

### Long-Term (Future)

1. **Replace Stub Embeddings**
   - Train or load real word embeddings
   - Better semantic similarity for facet queries

2. **Performance Optimization**
   - Cache facet query results
   - Spatial indexing for memory queries

3. **Advanced Facet Features**
   - Facet spreading (rumors, gossip)
   - Temporal facets (recent events stronger)
   - Facet relationships (semantic links)

---

## Conclusion

### Milestone 3.5 Status: **NOT FUNCTIONAL** ❌

**Assessment: 22% Complete**

The milestone appears complete in documentation but is actually non-functional in practice:

1. ✅ **Backend code exists** - Well-implemented, clean, follows style guide
2. ❌ **No integration** - Code is never called by running simulation
3. ❌ **No frontend** - Visualization components not created
4. ❌ **No tests** - Zero test coverage

**Root Cause:**
The facet/memory system was implemented in isolation without integration hooks. The documentation was written before the integration was attempted, leading to inaccurate "partial" status claims.

**Next Steps:**
1. Fix critical integrations (entity facets init, memory lifecycle in tick loop)
2. Implement missing `query-need-axis!` function
3. Create minimal frontend components
4. Write integration tests
5. Update documentation to reflect actual status

**Definition of Met: NOT MET**
- ❌ Agents perceive world through facet-based queries
- ❌ Memories decay and are cleaned up
- ❌ Frontend visualizes memories on map
- ❌ Frontend controls facet system parameters
- ❌ Tests verify all functionality

---

## Change Log

### 2026-01-22
- ✅ Reviewed all Milestone 3.5 documentation
- ✅ Audited actual backend implementation
- ✅ Identified critical integration gaps
- ✅ Verified frontend implementation status
- ✅ Calculated actual completion percentage
- ✅ Documented blockers and recommendations
