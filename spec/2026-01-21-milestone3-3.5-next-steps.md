# 2026-01-21 — Milestone 3 & 3.5 Next Steps

## Incomplete Work Identified in the Specs
- **Milestone 3 observability**: `backend/src/fantasia/sim/jobs.clj#L13-L220` still lacks the `[JOB:*]` logs described in `spec/2026-01-18-observability.md` (create/assign/progress/complete), `backend/src/fantasia/sim/pathing.clj#L5-L120` is not logging `[PATH:*]`, and `backend/src/fantasia/sim/tick.clj#L80-L140` is not emitting `[MOVE:AGENT]`/`]JOB:ADJACENT]` entries. Without those logs, verification scenarios from the same spec cannot run.
- **Verification scenarios** (chop tree, build wall, eat food, navigate walls) remain blocked because logs and trace outputs are missing and the test suite status is uncertain (`clojure -M:test` has not been run successfully yet).
- **Frontend telemetry**: `web/src/components/AgentCard.tsx`, `JobQueuePanel.tsx`, and `BuildControls.tsx` do not surface needs, job progress, or memory state, and there is no `MemoryOverlay.tsx`/`FacetControls.tsx` or `/board` + `/command` route support yet, so Milestone 3.5 frontend story points are incomplete.
- **Lifecycle extensions** specified in `spec/2026-01-19-milestone3-lifecycle.md` (agent stats, multi-inventory, reproduction, new buildings, water jobs) are not implemented; there is no mention of them in existing codebases.

## Code References & Hotspots Needing Action
- `backend/src/fantasia/sim/jobs.clj#L13-L220` – instrumentation hooks around `create-job`, `claim-next-job!`, `advance-job!`, and the per-job completion helpers (e.g., `complete-chop-tree!` at ~L122). Logging additions here answer Phases 1–4 of the observability spec.
- `backend/src/fantasia/sim/pathing.clj#L5-L120` – add `[PATH:REQUEST]`/`[PATH:RESULT]` around `bfs-path`, `a-star-path`, `next-step-toward` to close Phase 5.
- `backend/src/fantasia/sim/tick.clj#L80-L150` – `move-agent-with-job` should emit `[MOVE:AGENT]` plus `[JOB:ADJACENT]`/`[JOB:NOT-ADJACENT]` hooks so Phase 6 ends with movement logs.
- `web/src/components/AgentCard.tsx` & `JobQueuePanel.tsx` – need needs bars, job-progress badges, and ability to display hauling inventories (Milestone 3 frontend requirements + 3.5 memory indicators).
- `web/src/App.tsx` / router entry – add React Router with `/`, `/board`, and `/command` routes while reusing the existing WS client state (see `spec/2026-01-19-milestone3-lifecycle.md` Phase 4).
- Future components: planned `MemoryOverlay.tsx`, `FacetControls.tsx`, `MemoryFeed`, `TraceFeed` (per `spec/2026-01-19-milestone3-facets.md`) are still TODO.

## Open Issues and PRs
- Issue #4 (“Milestone 3 — Colony Job Loop”) tracks the job/need/stockpile work that still needs verification and logging.
- Issue #5 (“Champion Control & Day/Night”) depends on Milestone 3/3.5 stability before gating; keep it in mind for later.
- Issue #15 (“Observability”) is the runnable blocker for verification scenarios.
- Issue #8 (“Bridge Myth Engine”) will rely on stable logs and memory data from Milestones 3/3.5.
- No PR currently completes these missing observability/UI pieces; no outstanding PR to merge (checked `gh pr list`).

## Definition of Done (Milestone 3 + 3.5 completion)
1. All `jobs/pathing/tick` logging phases from `spec/2026-01-18-observability.md` are implemented and triggered in the live tick loop, producing `[JOB:*]`, `[PATH:*]`, and `[MOVE:AGENT]` entries for the four verification scenarios.
2. The verification scenarios (chop tree → wood, build wall, eat food, pathing around walls) can be executed with recorded logs/traces; `clojure -M:test` passes and validation scripts run deterministically.
3. Frontend AgentCard/JobQueuePanel visualize needs, inventories, job progress, and show corpses/buildings/resources; new `/board` and `/command` routes exist with an analytics dashboard + canvas-only view.
4. Facet/memory system is surfaced via the UI (`MemoryOverlay`, facet controls) and influences agent behavior (danger/safety axes reflected in job creation).
5. Lifecycle requirements from `spec/2026-01-19-milestone3-lifecycle.md` (agent stats, multi-inventory, buildings/resources, water jobs, reproduction) are implemented or have clear follow-up tickets.
6. Documentation (this spec + `/docs/notes`) captures the manual verification steps, logging behaviors, and UI changes.

## Requirements (from roadmap & specs)
1. Instrument every job creation/assignment/progress/completion (jobs.clj, tick.clj) and all pathfinding/movement steps (pathing.clj, tick.clj) so the job loop can be traced end-to-end (`spec/2026-01-18-observability.md`).
2. Prove functionality via the four verification scenarios before closing Milestone 3 (logs + `clojure -M:test`).
3. Present needs/job state to the web UI and build the `/board` + `/command` routes while reusing the existing WS client context (`spec/2026-01-19-milestone3-lifecycle.md`).
4. Frontend must display the facet/memory overlays and controls described in `spec/2026-01-19-milestone3-facets.md` and track loading state for `MemoryOverlay`, `FacetControls`, `MemoryFeed`.
5. Agent lifecycle features (stats, multi-inventory, reproduction, water jobs, building nodes) must either be implemented or captured as explicit follow-up stories before shipping Milestone 3.5.

## Phased Plan (each phase ends with a build+test verification)

### Phase 1 — Observability & Verification (critical)
1. Add the log statements from Phases 1–6 of `spec/2026-01-18-observability.md` into `jobs.clj`, `pathing.clj`, and `tick.clj`, guarding them with `fantasia.dev.logging` helpers so the log level can be managed via `LOG_LEVEL`.
2. Run `clojure -M:test` and the four verification scripts (chop tree, build wall, eat, path-around) to confirm the new logs fire; record one successful log trace per scenario in `/docs/notes` and mention the command outputs.
3. Document any uncovered bugs from the logs (blocks/bad paths) and resolve them before phase handoff. Code must still compile; rerun `clojure -M:server` smoke test if needed.

### Phase 2 — Frontend Instrumentation & Memory Visualization
1. Extend `AgentCard.tsx` and `JobQueuePanel.tsx` to render need bars, inventory badges, job progress percentages, and highlight corpses/resources per snapshots; ensure they read data from the same snapshot WS feed.
2. Introduce `MemoryOverlay.tsx` + `FacetControls.tsx` (or reuse existing `EventFeed`/`TraceFeed` pattern) to surface `[FACET:*]` and `[MEMORY:*]` logs; add a frontend handler for a `config_facets` WS op so the UI can toggle limits.
3. Add React Router to `web/src/App.tsx`, retaining `/` for the dashboard but adding `/board` (canvas-only) and `/command` (analytics) routes; confirm route transitions keep the same WS client alive.
4. Run `npm run test -- App.test.tsx` (or similar subset) to validate UI updates; restart `npm run dev` if necessary to check live behavior.

### Phase 3 — Lifecycle Completeness & Documentation
1. Complete or explicitly backlog lifecycle extras from `spec/2026-01-19-milestone3-lifecycle.md`: agent stats (strength/dexterity/fortitude/charisma), multi-inventory slots (`:personal`, `:hauling`, `:equipment`), building/resource archetypes (town centers, fences, tents, stockpiles, water nodes, chickens), and reproduction/water jobs. Tie hauling logic to the new inventories and log inventory changes via `[INVENTORY:*]` entries.
2. Ensure facet/memory outputs influence agent behavior: `query-need-axis!` should feed job priority heuristics, reproduction should look at facet scores before spawning. Capture the heuristics in `/docs/notes/milestone3-lifecycle.md` or here.
3. Link documentation to logging/verification steps so reviewers can replay them; add a short manual in `/docs/notes/planning` describing the log commands, route names, and frontend components. Confirm each new doc change references the spec and include manual command outputs.
4. After completing this phase, rerun both backend (`clojure -M:test`) and frontend (`npm test`) suites and record results in the doc; share any issues blocking completion before closing the milestone.

## Progress Updates
### 2026-01-21
- Added structured logging to the job loop, pathfinding, and movement layers so Phases 1–6 of `spec/2026-01-18-observability.md` are unblocked. Updated files: `backend/src/fantasia/sim/jobs.clj`, `backend/src/fantasia/sim/jobs/providers.clj`, `backend/src/fantasia/sim/pathing.clj`, `backend/src/fantasia/sim/tick/movement.clj`.
- Logging uses `fantasia.dev.logging` (`log-info` for job lifecycle + auto-gen summaries, `log-debug` for progress/path/movement). To see the new output, run with `LOG_LEVEL=info` or `LOG_LEVEL=debug`.
- Fixed backend test hygiene: renamed `backend/test/fantasia/sim/fire_creation_test.clj`, rewrote `backend/test/fantasia/sim/traces_test.clj`, updated `backend/test/fantasia/sim/core_test.clj` for wildlife counts, and adjusted `backend/test/fantasia/sim/spatial_test.clj` + `backend/test/fantasia/sim/fire_creation_test.clj` for current APIs.
- Guarded mood bonus math against nil values in `backend/src/fantasia/sim/agents.clj` to avoid `update-needs` crashes during long-running simulation tests.
- Backend test run `clojure -X:test` currently times out at 120s due to long-running simulation tests; rerun with a longer timeout or split into targeted suites after this phase.
