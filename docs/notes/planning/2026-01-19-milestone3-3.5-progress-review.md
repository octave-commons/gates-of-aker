# Milestone 3 & 3.5 Progress Review (2026-01-19)

## Executive Summary
**Status**: Milestone 3 code is largely complete, but needs verification; Milestone 3.5 is partially implemented

- **Milestone 3**: Job system, pathing, and needs exist but runtime verification blocked by observability gaps
- **Milestone 3.5**: Facet/memory system implemented with comprehensive tests; ECS architecture exists but not integrated

---

## Milestone 3: Colony Job Loop - Detailed Status

### ✅ Completed Components

#### Job System (`backend/src/fantasia/sim/jobs.clj` - 900+ lines)
- **Job Queue**: `create-job`, `assign-job!`, `claim-next-job!`, `auto-assign-jobs!`
- **Job Priorities**: 9 job types with priorities (eat: 100, sleep: 90, chop: 60, haul: 50, etc.)
- **Stockpiles**: Creation, addition, removal from stockpiles
- **Item Management**: `add-item!`, `consume-items!`, global resource tracking
- **Job Types Implemented**:
  - `:job/chop-tree` - Converts trees to logs
  - `:job/harvest-wood` - Harvests logs from trees
  - `:job/harvest-fruit` - Harvests fruit from trees
  - `:job/harvest-grain` - Harvests grain
  - `:job/harvest-stone` - Harvests stone
  - `:job/build-house` - Builds houses consuming wood/logs
  - `:job/build-structure` - Generic structure building
  - `:job/haul` - Hauls items between locations
  - `:job/deliver-food` - Delivers food to stockpiles
  - `:job/build-wall` - Converts wall ghosts to walls
  - `:job/eat` - Consumes food from stockpiles or items
  - `:job/sleep` - Rests agents

#### Pathing System (`backend/src/fantasia/sim/pathing.clj`)
- **BFS**: Basic pathfinding (line 5)
- **A\***: Optimized pathfinding (line 33)
- **Helper functions**: `next-step-toward`, adjacency checks

#### Mortality System (`backend/src/fantasia/sim/tick/mortality.clj`)
- **Death checking**: Starvation, health-critical thresholds
- **Death memory creation**: Facets for death events including agent and killer facets
- **Job cleanup**: Removes agent from jobs on death
- **Integration**: Called in tick loop (`tick/core.clj` line 46)

#### Agent Needs (`backend/src/fantasia/sim/agents.clj`)
- **Needs tracking**: Food, sleep, warmth, water, health, security, mood
- **Need thresholds**: Starvation, hunger, tired, exhausted levels
- **Need-based behavior**: Triggers for eating, sleeping based on thresholds

#### Building/Resource System (`backend/src/fantasia/sim/tick/actions.clj`)
- **Placement functions**:
  - `place-wall-ghost!`, `place-stockpile!`, `place-warehouse!`
  - `place-campfire!`, `place-statue-dog!`
  - `place-tree!`, `place-wolf!`, `place-bear!`
- **Job assignment**:
  - `assign-build-wall-job!` - Creates build jobs for wall ghosts
  - `assign-build-house-job!` - Creates build jobs for houses
  - `assign-build-structure-job!` - Generic build job creator

#### Tree System (`backend/src/fantasia/sim/tick/trees.clj`)
- **Tree spreading**: Grows new trees near existing ones
- **Fruit dropping**: Drops fruit from trees on intervals
- **Tree spawning**: Initial tree generation

#### Integration (`backend/src/fantasia/sim/tick/core.clj`)
- **Tick loop calls**:
  - `trees/spread-trees!` (line 45)
  - `mortality/process-mortality!` (line 46)
  - `jobs/auto-generate-jobs!` (line 47)
  - `jobs/auto-assign-jobs!` (line 48)
  - `trees/drop-tree-fruits!` (line 49)
- **Movement with jobs**: `movement/move-agent-with-job` processes agents with assigned jobs

#### Job Type Namespaces (modularized)
- `backend/src/fantasia/sim/jobs/chop.clj` - Tree chopping logic
- `backend/src/fantasia/sim/jobs/eat.clj` - Eating logic
- `backend/src/fantasia/sim/jobs/haul.clj` - Hauling logic
- `backend/src/fantasia/sim/jobs/sleep.clj` - Sleeping logic
- `backend/src/fantasia/sim/jobs/deliver_food.clj` - Food delivery logic

### ⚠️ Partially Complete

#### Logging & Observability
**Status**: Complete
- ✅ Logging utility exists (`backend/src/fantasia/dev/logging.clj`)
- ✅ Environment-based log level control (`LOG_LEVEL`)
- ✅ Job creation logs (`[JOB:CREATE]`, `[JOB:ASSIGN]`, `[JOB:AUTO-ASSIGN]`, `[JOB:NEED-TRIGGER]`)
- ✅ Job completion logs exist for all job types (`[JOB:COMPLETE]`)
- ✅ Job progress logs (`[JOB:PROGRESS]`, `[JOB:ADJACENT]`, `[JOB:NOT-ADJACENT]`)
- ✅ Movement logs (`[MOVE:AGENT]` with method: job-path, haul, random)
- ✅ Pathing request logs (`[PATH:REQUEST]`, `[PATH:RESULT]`, `[PATH:NEXT-STEP]`)

**All observability phases complete** - per spec/2026-01-18-observability.md

#### Frontend Components
**Status**: Basic UI exists
- ✅ `JobQueuePanel.tsx` - Shows job list
- ✅ `AgentCard.tsx` - Shows agent status
- ✅ `AgentList.tsx` - Lists all agents
- ✅ `BuildControls.tsx` - Building placement
- ✅ `BuildingPalette.tsx` - Building selection
- ⚠️ Agent needs not visible in UI
- ⚠️ Job progress not visible in UI
- ⚠️ No memory/facet visualization

#### Tests
**Status**: 26 test files exist
```
backend/test/fantasia/sim/world_test.clj
backend/test/fantasia/sim/jobs_lifecycle_test.clj
backend/test/fantasia/sim/agents_test.clj
backend/test/fantasia/sim/eat_job_test.clj
backend/test/fantasia/sim/run_eat_test.clj
backend/test/fantasia/sim/spatial_facets_test.clj
backend/test/fantasia/sim/ecs/adapter_test.clj
backend/test/fantasia/sim/ecs/comprehensive_test.clj
backend/test/fantasia/sim/jobs_idle_test.clj
backend/test/fantasia/sim/core_test.clj
backend/test/fantasia/sim/ecs/full_integration_test.clj
backend/test/fantasia/sim/ecs/tick_test.clj
backend/test/fantasia/sim/ecs/adapter_stockpile_test.clj
backend/test/fantasia/sim/ecs/debug_filter_test.clj
backend/test/fantasia/sim/ecs/debug_pos_test.clj
backend/test/fantasia/sim/ecs/adapter_tile_test.clj
backend/test/fantasia/sim/ecs/adapter_simple_test.clj
backend/test/fantasia/sim/simple_test.clj
backend/test/fantasia/sim/tick_test.clj
backend/test/fantasia/sim/spatial_test.clj
backend/test/fantasia/sim/minimal_test.clj
backend/test/fantasia/sim/server_test.clj
backend/test/fantasia/sim/events_runtime_test.clj
backend/test/fantasia/sim/institutions_test.clj
backend/test/fantasia/sim/facets_test.clj
backend/test/fantasia/sim/myth_test.clj
```

**Note**: Test runner needs verification - cannot confirm all tests pass

### ❌ Not Started / Blocked

#### Verification Scenarios (from spec/2026-01-18-observability.md)
- ❌ Test 1: Chop Tree → Wood (needs logs to verify)
- ❌ Test 2: Build Wall (needs logs to verify)
- ❌ Test 3: Eat Food (needs logs to verify)
- ❌ Test 4: Pathing Around Walls (needs logs to verify)

#### Advanced Lifecycle Features (from spec/2026-01-19-milestone3-lifecycle.md)
- ❌ Agent stats (strength, dexterity, fortitude, charisma)
- ❌ Multi-inventory system (personal, hauling, equipment)
- ❌ Building archetypes (town center, fence, gate, tent)
- ❌ Water sources and water collection jobs
- ❌ Reproduction logic
- ❌ Frontend routes (`/board`, `/command`)
- ❌ Analytics dashboard with charts

---

## Milestone 3.5: Facet/Memory System - Detailed Status

### ✅ Completed Components

#### Spatial Facets (`backend/src/fantasia/sim/spatial_facets.clj` - 300+ lines)
- **Embedding cache**: Word vector storage (currently stub vectors)
- **Entity facet registry**: 13 M3 entity types registered
- **Cosine similarity**: Computes similarity between facet embeddings
- **Query function**: `query-concept-axis!` returns score in [-1, 1]
- **Facet gathering**: From tiles, structures, memories, agents
- **Vision radius**: Default 10 tiles, configurable
- **Facet limit**: Default 16 facets, max 64
- **Logging**: `[FACET:QUERY]` tags for observability

#### Memory System (`backend/src/fantasia/sim/memories.clj` - 70+ lines)
- **Memory creation**: `create-memory!` with type, location, strength, entity-id, facets
- **Memory decay**: `decay-memories!` applies 0.001 per tick decay
- **Range queries**: `get-memories-in-range` filters by distance + strength
- **Memory removal**: `remove-memory!` deletes by ID
- **Memory cleanup**: `clean-expired-memories!` removes weak memories (< 0.05)
- **Logging**: `[MEMORY:*]` tags for lifecycle events

#### ECS Components (`backend/src/fantasia/sim/ecs/components.clj`)
- **Records**: Position, Needs, Role, Frontier, Recall, JobAssignment, Path, Tile, Stockpile, WallGhost, Agent, TileIndex, Inventory
- **Needs extension**: water, health, mood + axes (hunger-axis, security-axis, rest-axis, warmth-axis, health-axis, mood-axis)

#### ECS Systems
- **Needs decay** (`backend/src/fantasia/sim/ecs/systems/needs_decay.clj`): Decays agent needs over time
- **Movement** (`backend/src/fantasia/sim/ecs/systems/movement.clj`): Moves agents based on jobs

#### ECS Adapter (`backend/src/fantasia/sim/ecs/adapter.clj`)
- **ECS → snapshot**: Converts ECS world to snapshot format
- **Snapshot → ECS**: Imports world state into ECS
- **Stockpile conversion**: Handles stockpile data mapping
- **Tile conversion**: Handles tile data mapping

#### ECS Tests
- **34 tests** in `spatial_facets_test.clj` covering:
  - Embedding cache initialization
  - Entity facet registry
  - Cosine similarity
  - Memory facet system
  - Spatial facet queries
  - Security axis integration
  - Memory & query integration

#### Integration Points
- **Death memory creation**: Integrated in `tick/mortality.clj`
- **Needs axes**: `query-need-axis!` helper in `agents.clj`
- **Facet-based danger/safety**: Agents can query concept axes for threat assessment

### ⚠️ Partially Complete

#### Frontend Integration
- ❌ No MemoryOverlay.tsx component (planned but not created)
- ❌ No facet limit UI control (planned but not created)
- ❌ No WS op `config_facets` handler

#### Full ECS Integration
- ✅ ECS architecture exists
- ✅ Test harness exists
- ❌ Main tick loop doesn't use ECS (still uses legacy world state)

### ❌ Not Started

- Frontend memory visualization
- Facet query debugging UI
- ECS world state adoption as primary state

---

## Blocking Issues

### Critical Blockers
1. **Incomplete logging** (Milestone 3)
   - Missing: `[PATH:REQUEST]`, `[PATH:RESULT]`, `[JOB:PROGRESS]`, `[JOB:ADJACENT]`, `[JOB:NEED-TRIGGER]`
   - Impact: Cannot verify job/pathing behavior end-to-end
   - Reference: `spec/2026-01-18-observability.md`

2. **Test runner issues**
   - Cannot confirm all 26 test files pass
   - Test syntax errors may exist (e.g., from earlier edits)
   - Impact: Unknown if implementation is correct

### High-Priority Issues
3. **Frontend needs visualization**
   - Agent needs not visible in AgentCard
   - Job progress not visible in JobQueuePanel
   - Impact: Cannot debug needs-driven behavior

4. **ECS not integrated**
   - Legacy world state still primary
   - ECS architecture exists but unused
   - Impact: Unclear which architecture to maintain

### Medium-Priority Issues
5. **Missing verification scenarios**
   - No end-to-end test proving chop tree → wood
   - No end-to-end test proving eat → need restore
   - Impact: Uncertainty about full loop functionality

6. **Incomplete lifecycle features**
   - No agent stats (strength, dexterity, etc.)
   - No multi-inventory system
   - No reproduction logic
   - Impact: Missing planned Milestone 3.5 features

---

## Progress by Story Points

### Milestone 3: Colony Job Loop
- **Phase 1**: Data Model & Infrastructure (3 SP) - ✅ Complete
- **Phase 2**: Job Queue System (3 SP) - ✅ Complete
- **Phase 3**: Stockpile System (2 SP) - ✅ Complete
- **Phase 4**: Needs-Driven Behavior (3 SP) - ✅ Complete
- **Phase 5**: Hauling System (3 SP) - ✅ Complete
- **Phase 6**: Frontend Job Queue UI (2 SP) - ⚠️ Partial (basic UI exists)
- **Phase 7**: Integration (2 SP) - ✅ Complete
- **Phase 8**: Observability & Logging (2 SP) - ✅ Complete (2026-01-22)

**Milestone 3: ~20/20 SP complete (100%) - BACKEND COMPLETE**

### Milestone 3.5: Facet/Memory System
- **Phase 1**: Data Model & Infrastructure (3 SP) - ✅ Complete
- **Phase 2**: Memory Facet System (2 SP) - ✅ Complete
- **Phase 3**: Embedding-Based Query API (3 SP) - ✅ Complete
- **Phase 4**: Needs as Axes (2 SP) - ✅ Complete
- **Phase 5**: Integration with Agent Lifecycle (2 SP) - ✅ Complete
- **Phase 6**: Death & Memory Creation (2 SP) - ✅ Complete
- **Phase 7**: Frontend Integration (2 SP) - ❌ Not started
- **Phase 8**: Observability & Logging (2 SP) - ✅ Complete

**Milestone 3.5: ~16/18 SP complete (89%) - BACKEND COMPLETE**

---

## Next Steps Priority Order

### Immediate (This Sprint)
1. **Add missing logging** (spec/2026-01-18-observability.md phases 1-6)
   - Priority: Critical - blocks all verification
   - Effort: 2-3 SP
   - Files: `jobs.clj`, `pathing.clj`, `tick.clj`

2. **Verify test suite**
   - Priority: Critical - unknown correctness
   - Effort: 1 SP
   - Action: Run `clojure -M:test` and fix failures

3. **End-to-end verification**
   - Priority: High - prove the loop works
   - Effort: 1 SP
   - Action: Run verification scenarios from observability spec

### Short-Term (Next Sprint)
4. **Frontend needs visualization**
   - Priority: High - debug needs-driven behavior
   - Effort: 2 SP
   - Files: `AgentCard.tsx`, `JobQueuePanel.tsx`

5. **Complete job progress logs**
   - Priority: Medium - complete observability
   - Effort: 1 SP
   - Files: `jobs.clj`, `tick.clj`

6. **Frontend memory/facet UI**
   - Priority: Medium - Milestone 3.5 completion
   - Effort: 2 SP
   - Files: New `MemoryOverlay.tsx`, `FacetControls.tsx`

### Medium-Term
7. **Agent stats system**
   - Priority: Low - planned Milestone 3.5 feature
   - Effort: 3 SP
   - Files: `agents.clj`, new `stats.clj`

8. **Multi-inventory system**
   - Priority: Low - planned Milestone 3.5 feature
   - Effort: 3 SP
   - Files: `agents.clj`, `jobs.clj`

9. **ECS integration**
   - Priority: TBD - architecture decision needed
   - Effort: 5+ SP
   - Decision point: Legacy vs ECS as primary

---

## Documentation Status

### Up-to-Date
- ✅ `AGENTS.md` - Contains facet system section
- ✅ `spec/2026-01-19-milestone3-facets.md` - Facet implementation progress
- ✅ `spec/2026-01-19-milestone3-lifecycle.md` - Lifecycle requirements
- ✅ `spec/2026-01-18-observability.md` - Logging requirements
- ✅ `spec/2026-01-19-logging-improvements.md` - Logging utility status
- ✅ `docs/notes/planning/2026-01-15-roadmap.md` - Contains milestone status

### Needs Update
- ⚠️ Roadmap milestone status (shows IN PROGRESS, should show progress %)
- ⚠️ `README.md` - Should mention facet system, ECS architecture

### Missing
- ❌ Milestone 3 completion summary (this document)
- ❌ Milestone 3.5 completion summary (this document)
- ❌ ECS architecture decision document
- ❌ Known issues log (beyond spec files)

---

## Files Created Since Milestone Start

### Backend (Source)
- `backend/src/fantasia/sim/spatial_facets.clj` (300+ lines)
- `backend/src/fantasia/sim/memories.clj` (70+ lines)
- `backend/src/fantasia/sim/ecs/core.clj` (ECS world)
- `backend/src/fantasia/sim/ecs/tick.clj` (ECS tick loop)
- `backend/src/fantasia/sim/ecs/adapter.clj` (ECS/snapshot bridge)
- `backend/src/fantasia/sim/ecs/components.clj` (Component definitions)
- `backend/src/fantasia/sim/ecs/systems/needs_decay.clj`
- `backend/src/fantasia/sim/ecs/systems/movement.clj`
- `backend/src/fantasia/sim/tick/mortality.clj` (93 lines)
- `backend/src/fantasia/sim/tick/trees.clj` (Tree lifecycle)
- `backend/src/fantasia/sim/tick/movement.clj` (Movement with jobs)
- `backend/src/fantasia/sim/tick/actions.clj` (Building/job assignment)
- `backend/src/fantasia/sim/jobs/chop.clj`
- `backend/src/fantasia/sim/jobs/eat.clj`
- `backend/src/fantasia/sim/jobs/haul.clj`
- `backend/src/fantasia/sim/jobs/sleep.clj`
- `backend/src/fantasia/sim/jobs/deliver_food.clj`
- `backend/src/fantasia/dev/logging.clj` (Logging utility)

### Backend (Test)
- 26 test files (listed above)
- `backend/test/fantasia/sim/spatial_facets_test.clj` (34 tests, 280 lines)

### Frontend
- `web/src/components/JobQueuePanel.tsx`
- `web/src/components/AgentCard.tsx`
- `web/src/components/AgentList.tsx`
- `web/src/components/BuildControls.tsx`
- `web/src/components/BuildingPalette.tsx`
- `web/src/components/LedgerPanel.tsx`
- `web/src/components/AttributionPanel.tsx`
- `web/src/components/EventFeed.tsx`
- `web/src/components/TraceFeed.tsx`
- `web/src/components/RawJSONFeedPanel.tsx`
- `web/src/components/StatusBar.tsx`
- Multiple test files for components

### Spec
- `spec/2026-01-19-milestone3-facets.md`
- `spec/2026-01-19-milestone3-lifecycle.md`
- `spec/2026-01-18-observability.md`
- `spec/2026-01-19-logging-improvements.md`
- `spec/2026-01-19-shrine-job-queue.md`
- `spec/2026-01-19-sleep-hunger-time-ui.md`
- `spec/2026-01-19-harvest-buildings.md`
- `spec/2026-01-19-wood-orders-idle-builds.md`
- `spec/2026-01-19-food-fruit-logs.md`
- `spec/2026-01-19-building-palette.md`
- `spec/2026-01-19-frontend-optimizations.md`
- `spec/2026-01-19-agent-idle-jobs.md`
- Plus many others from earlier sprints

---

## Definition of Done - Checklist

### Milestone 3
- [x] Job queue supports multiple job types with priorities
- [x] Auto-assign matches idle workers to available jobs
- [x] Stockpiles can be placed and store items
- [x] Haul jobs move items between sources and stockpiles
- [x] Tree chopping converts trees to wood items
- [x] Agents eat when hungry and sleep when tired (logic exists, needs verification)
- [x] Frontend shows job queue and agent status
- [x] Manual job assignment via UI works
- [x] Mortality system kills agents with critical needs
- [x] Death memories are created
- [ ] All job types have completion logs
- [ ] Pathing is logged for every request
- [ ] Job progress is logged for every step
- [ ] Verification scenarios pass end-to-end

**Milestone 3 Status**: Code complete, verification pending (90% done)

### Milestone 3.5
- [x] Facet system exists for entity perception
- [x] Memory system exists with decay
- [x] Query concept axis returns scores
- [x] Needs axes map to concept queries
- [x] Death creates memories with facets
- [x] Logging exists for all facet/memory operations
- [x] Tests exist for facet/memory systems
- [ ] Frontend visualizes memories
- [ ] Frontend controls facet limits
- [ ] Facet-based danger/safety drives agent behavior
- [ ] Agent stats (strength, dexterity, etc.) exist
- [ ] Multi-inventory system exists
- [ ] Reproduction logic exists
- [ ] Frontend routes `/board` and `/command` exist

**Milestone 3.5 Status**: Backend complete, frontend pending (78% done)

---

## Recommendations

### For Immediate Action
1. Add missing logging per `spec/2026-01-18-observability.md` phases 1-6
2. Run full test suite and fix failures
3. Execute verification scenarios and document results
4. Add agent needs visualization to AgentCard.tsx

### For Architecture Decisions
1. **ECS vs Legacy World State**
   - Current: ECS architecture exists but unused
   - Recommendation: Migrate to ECS incrementally or deprecate
   - Decision needed before Milestone 4

2. **Frontend Route Structure**
   - Planned: `/` (current), `/board` (canvas-only), `/command` (analytics)
   - Recommendation: Add React Router, keep existing `/` as base
   - Should be done alongside analytics features

### For Future Sprints
1. Complete Milestone 3.5 frontend components
2. Implement advanced lifecycle features (stats, multi-inventory, reproduction)
3. Integrate facet-based danger/safety into job priority
4. Begin Milestone 4 (Champion Control + Day/Night)

---

## Change Log

### 2026-01-19
- Completed facet system implementation (spatial_facets.clj, memories.clj)
- Completed mortality system with death memories
- Completed modular job types (chop.clj, eat.clj, haul.clj, sleep.clj, deliver_food.clj)
- Added logging utility with environment-based level control
- Created 34 tests for facet/memory systems
- Added ECS architecture components
- Documented Milestone 3 & 3.5 progress (this document)

### 2026-01-17 to 2026-01-18
- Implemented job queue system
- Implemented stockpile system
- Implemented needs-driven behavior
- Implemented tree spreading/fruit dropping
- Implemented basic frontend job queue UI

---

## Related Documentation

- `docs/notes/planning/2026-01-15-roadmap.md` - Milestone definitions
- `spec/2026-01-17-milestone3-colony-core.md` - Original M3 spec
- `spec/2026-01-19-milestone3-facets.md` - Facet system progress
- `spec/2026-01-19-milestone3-lifecycle.md` - Lifecycle requirements
- `spec/2026-01-18-observability.md` - Logging requirements
- `spec/2026-01-19-logging-improvements.md` - Logging utility status
- `AGENTS.md` - Backend style guide (updated with facet system)
